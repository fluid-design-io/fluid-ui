name: CI
on:
  push:
    branches: [main]
  pull_request:
    branches: '*'
jobs:
  quality:
    name: Build, lint, and test on Node ${{ matrix.node }} and ${{ matrix.os }}

    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        node: ['14.x', '16.x']
        #os: [ubuntu-latest, windows-latest, macOS-latest]
        os: [ubuntu-latest]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v2

      - name: Use Node ${{ matrix.node }}
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node }}

      - name: Install deps and build (with cache)
        uses: bahmutov/npm-install@v1

      - name: Lint
        run: yarn lint

      - name: Test
        run: yarn test --ci --coverage --maxWorkers=2

      - name: Build
        run: yarn build
  publish:
    runs-on: ubuntu-latest
    if: ${{ github.ref == 'refs/heads/main' }}
    needs: [quality]
    steps: 
    - uses: actions/checkout@v2
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v2
      with:
        node-version: ${{ matrix.node-version }}
    
    - name: Action For Semantic Release
      # You may pin to the exact commit or the version.
      # uses: cycjimmy/semantic-release-action@3b88c82b34098e8b51e401c1082c9170b0a3ec3c
      uses: cycjimmy/semantic-release-action@v3.0.0
      with:
        # Specify specifying version range for semantic-release. If no version range is specified, latest version will be used by default
        #semantic_version: # optional
        # The branches on which releases should happen. It will override the branches attribute in your configuration file. Support for semantic-release above v16. See https://semantic-release.gitbook.io/semantic-release/usage/configuration#branches for more information.
        #branches: main
        # The branch on which releases should happen. It will override the branch attribute in your configuration file. If the attribute is not configured on both sides, the default is master. Support for semantic-release older than v16.
        branch: main
        # Extra plugins for pre-install. You can also specify specifying version range for the extra plugins if you prefer.
        #extra_plugins: # optional
        # Whether to run semantic release in `dry-run` mode. It will override the dryRun attribute in your configuration file
        #dry_run: # optional
        # One or several sharable configurations, https://semantic-release.gitbook.io/semantic-release/usage/configuration#extends
        #extends: # optional
        # Specify another working directory for semantic release. Default one is provided by github.
        #working_directory: # optional
      env: 
        NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
